define.experiment.newDataSchema("TPALinkedinFollowProperties.LinkedinFollow.New",function(){return{companyName:{type:"string","default":"Wix.com",description:"the name of the company in linkedin"},dataId:{type:"number","default":97250,description:"the id of the company in linkedin"},language:{type:"string","enum":["en_US","fr_FR","ru_RU"],"default":"en_US",description:"the position of the follow counter around the button"},dataCounter:{type:"string","enum":["top","right","none"],"default":"top",description:"the position of the follow counter around the button"}}}),define.Class("wysiwyg.viewer.managers.TPAManager",function(a){var b=a;b.inherits("bootstrap.managers.BaseManager"),b.utilize(["wysiwyg.viewer.managers.tpa.URLBuilder","wysiwyg.viewer.managers.tpa.TPAComponentRegistrar","wysiwyg.viewer.managers.tpa.PixelTracker"]),b.resources(["scriptLoader","W.Commands","W.CommandsNew","W.Utils"]),b.binds(["_onAppAvailableTimeoutExpires"]),b.statics({TPA_MESSAGE:"TPA",TPA_MESSAGE2:"TPA2",TPA_RESPONSE:"TPA_RESPONSE",APP_MARKET_MESSAGE:"APP_MARKET",APP_MARKET_URL:"http://market.apps.wix.com",PINGPONG_PREFIX:"pingpong:",LOAD_TIMEOUT:20,MessageTypes:{CHANGE_APP_SIZE:"changeAppSize",RESIZE_WINDOW:"resizeWindow",SET_WINDOW_PLACEMENT:"setWindowPlacement",GET_WINDOW_PLACEMENT:"getWindowPlacement",REFRESH_APP:"refreshApp",APP_IS_ALIVE:"appIsAlive",APP_STATE_CHANGED:"appStateChanged",CLOSE_POPUP:"closePopup",CLOSE_WINDOW:"closeWindow",OPEN_POPUP:"openPopup",OPEN_RELATIVE_POPUP:"openRelativePopup",OPEN_MODAL:"openModal",OPEN_MEDIA_DIALOG:"openMediaDialog",OPEN_BILLING_PAGE:"openBillingPage",GET_SITE_PAGES:"getSitePages",GET_SITE_COLORS:"getSiteColors",NAVIGATE_TO_PAGE:"navigateToPage",POST_MESSAGE:"postMessage",SM_REQUEST_LOGIN:"pingpong:smRequestLogin",SM_CURRENT_MEMBER:"pingpong:smCurrentMember",SITE_INFO:"pingpong:siteInfo",EVENT_LISTENER_ADDED:"pingpong:addEventListener",SM_REQUEST_LOGIN_2:"smRequestLogin",SM_CURRENT_MEMBER_2:"smCurrentMember",SITE_INFO_2:"siteInfo",SCROLL_TO:"scrollTo",SCROLL_BY:"scrollBy",HEIGHT_CHANGED:"heightChanged",APP_SETTINGS_CHANGED:"appSettingsChanged",APP_SETTINGS_CLOSE:"appSettingsClose",APP_SHOW_POPUP:"appShowPopup"}}),b.methods({initialize:function(){this._setAppMarketUrl(),this._urlBuilder=new this.imports.URLBuilder,this._componentRegistrar=new this.imports.TPAComponentRegistrar,this._addPostMessageCallback(function(a){this.handlePostMessage(a,function(a){var b=$(a);return b&&b.getLogic()})}.bind(this)),this._testAppsDefIds=this._getTestAppsDefIds(),this._registerPixelTrackerEvents()},_registerPixelTrackerEvents:function(){var a=this;resource.getResourceValue("W.Viewer",function(b){function c(a){var b,c=[],e=window.rendererModel.clientSpecMap||{};for(var f in e)b=d(e[f],a),b&&c.push(b);return c}function d(a,b){if(!a.pixelUrl)return"";var c=~a.pixelUrl.indexOf("?")?"&":"?";return"&"!==b.charAt(0)&&(b="&"+b),a.pixelUrl+c+"instance="+a.instance+b}return"site"!==b.getViewMode()?!1:(a.pixelTracker=new a.imports.PixelTracker(c),b.addEvent("SiteReady",function(){a.resources.W.Utils.hash.addEvent("change",function(b){b.isForSureAfterChange&&a.pixelTracker.sendAll("page="+window.location.href)})}),void 0)})},_setAppMarketUrl:function(){if(serviceTopology.baseDomain){var a=serviceTopology.baseDomain.indexOf("wixpress")>1;a&&serviceTopology.baseDomain.indexOf("burger")>-1&&(this.APP_MARKET_URL="http://market.burger.wixpress.com")}},isReady:function(){return!0},getAppMarketData:function(a,b){var c=this;resource.getResourceValue("W.Viewer",function(d){var e=d.getAppDataHandler().getAppDataByAppDefinitionId(a);e.marketData?b(e.marketData):c.resources.scriptLoader.loadResource({url:c.APP_MARKET_URL+"/api/market/app/"+a,usePlugin:"json"},{onLoad:function(a){c._setAppMarketingData(e,a),b(e.marketData)},onFailed:function(){b(null)}})})},_setAppMarketingData:function(a,b){a.marketData=b},_addPostMessageCallback:function(a){this._callbacks=this._callbacks||[],this._callbacks.push(a),window.addEventListener?window.addEventListener("message",a,!1):window.attachEvent&&window.attachEvent("onmessage",a)},handlePostMessage:function(a,b){if("string"==typeof a.data){var c="";try{c=JSON.parse(a.data)}catch(d){return}var e=c.type;c&&c.intent&&(c.intent===this.TPA_MESSAGE&&e?this._handleTPAMessage(c,e,b):c.intent===this.APP_MARKET_MESSAGE?this._handleAppMarketMessage(c):c.intent===this.TPA_MESSAGE2&&e&&this._handleTPAMessage2(c,e,b))}},_handleTPAMessage2:function(a,b,c){var d=a.compId,e=c(d);if(e)if(Object.contains(this.MessageTypes,b)){var f=this._getHandlerFunctionName(b),g=e[f];g?g.apply(e,[{msgData:a.data,callback:function(c){var f=e.getIFrame();f.contentWindow.postMessage(JSON.stringify({intent:this.TPA_RESPONSE,compId:d,callId:a.callId,type:b,res:c,status:!0}),"*")}.bind(this)}]):LOG.reportError("Handler function not found - "+b,"wysiwyg.viewer.managers.TPA","handlePostMessage2")}else LOG.reportError("Unknown post message type - "+b,"wysiwyg.viewer.managers.TPA","handlePostMessage")},_handleTPAMessage:function(a,b,c){var d=a.compId,e=c(d);if(e)if(Object.contains(this.MessageTypes,b)){var f=this._getHandlerFunctionName(b),g=e[f];g?this._isPingPongMessage(b)?g.apply(e,[{msgData:a.data,callback:function(a){var c=e.getIFrame();c.contentWindow.postMessage(JSON.stringify({intent:this.TPA_MESSAGE,compId:d,type:b,data:a}),"*")}.bind(this)}]):g.apply(e,[a.data]):LOG.reportError("Handler function not found - "+b,"wysiwyg.viewer.managers.TPA","handlePostMessage")}else LOG.reportError("Unknown post message type - "+b,"wysiwyg.viewer.managers.TPA","handlePostMessage")},_handleAppMarketMessage:function(a){switch(a.cmd){case"ADD_APP_TO_SITE":this.resources.W.Commands.executeCommand("WEditorCommands.AddApp",a.params,this),this.resources.W.Commands.executeCommand(Constants.EditorUI.CLOSE_PANEL);break;case"ADD_COMPONENT_TO_SITE":a.params&&"addLoginButton"===a.params.compType?this.resources.W.Commands.executeCommand("WEditorCommands.AddSMDependantComponent",{compType:"addLoginButton",styleId:""},this):this.resources.W.CommandsNew.executeCommand("WEditorCommands.AddComponent",a.params,this),this.resources.W.Commands.executeCommand(Constants.EditorUI.CLOSE_PANEL);break;case"OPEN_MARKET_POPUP":this.resources.W.Commands.executeCommand("WEditorCommands.openMarketPopup",a.params,this);break;case"CLOSE_MARKET_POPUP":this.resources.W.Commands.executeCommand("WEditorCommands.closeMarketPopup",a.params,this);break;case"GET_INSTALLED_APPS":var b=W.Preview.getPreviewManagers().Viewer.getAppDataHandler().getAppsData(),c={eventType:"ON_COMMAND_RESPONSE",callerId:a.id,params:b};this._marketPanelWindow.postMessage(JSON.stringify(c),this.APP_MARKET_URL);break;case"GET_TEST_APPS":this.getTestApps(function(b){var c={eventType:"ON_COMMAND_RESPONSE",callerId:a.id,params:b};this._marketPanelWindow.postMessage(JSON.stringify(c),this.APP_MARKET_URL)}.bind(this))}},setMarketPanelWindow:function(a){this._marketPanelWindow=a},_getHandlerFunctionName:function(a){return this._isPingPongMessage(a)&&(a=a.replace(this.PINGPONG_PREFIX,"")),"handle"+a.capitalize()},_isPingPongMessage:function(a){return 0==a.indexOf(this.PINGPONG_PREFIX)},getURLBuilder:function(){return this._urlBuilder},getComponentRegistrar:function(){return this._componentRegistrar},getSectionURL:function(a){var b=this._componentRegistrar.getPageId(a);if(null===b)return null;var c=W.Data.getDataByQuery("#"+b),d=c&&c.get("title");this.getPageState(b);var e=this.injects().Viewer.isPublicMode(),f=location.href.replace(location.hash,"");f=e?window.publicModel&&window.publicModel.externalBaseUrl||f:f;var g=f+"#!"+this.injects().Utils.hash.getHashPartsString(b,d);return g="/"==g.charAt(g.length-1)?g:g+"/"},_getTestAppsDefIds:function(){var a=[],b=W.Utils.getQueryParam("appDefinitionId");b&&a.push(b);var c=window.editorModel&&window.editorModel.runningApps||{},d="~";return Object.each(c,function(b,c){if("ON"==b.toUpperCase()){var e=c.lastIndexOf(d),f=e+1;if(c.length>f||e>0){var g=c.substr(f);a.push(g.trim())}}}.bind(this)),a},getTestApps:function(a){a(this._testAppsDefIds)},reportLoadStart:function(a){this._waitForAppAlive(a)},_waitForAppAlive:function(a){a.isAppAlive()||a.callLater(this._onAppAvailableTimeoutExpires,[a],1e3*this.LOAD_TIMEOUT)},_onAppAvailableTimeoutExpires:function(a){a.isAppAlive()||a.onError()},setPageState:function(a,b){this._stateByPage||(this._stateByPage={}),this._stateByPage[a]=b},getPageState:function(a){var b=this._stateByPage&&this._stateByPage[a];return b||""},getAppDefinitionId:function(a){var b=W.Preview.getPreviewManagers().Viewer.getAppDataHandler().getAppData(a);return b.appDefinitionId},getAppData:function(a){return W.Preview.getPreviewManagers().Viewer.getAppDataHandler().getAppData(a)},dispose:function(){for(var a;this._callbacks&&this._callbacks.length;)a=this._callbacks.pop(),window.removeEventListener?window.removeEventListener("message",a):window.detachEvent&&window.detachEvent("onmessage",a);this.parent()},postMessageEvent:function(a,b){var c=b||this._marketPanelWindow,d=location.protocol+"//"+location.host,e={eventType:a,origin:d};c.postMessage(JSON.stringify(e),this.APP_MARKET_URL)},clone:function(a){return this.parent(a)}})}),define.Class("wysiwyg.viewer.managers.tpa.URLBuilder",function(a){var b=a;b.resources(["W.Utils","W.Config"]),b.methods({buildStateLessUrl:function(a,b,c,d){return this._buildUrlInternal(a,!1,b,c,d)},buildStateFullUrl:function(a,b,c,d){return this._buildUrlInternal(a,!0,b,c,d)},_buildUrlInternal:function(a,b,c,d,e){if(!a)return null;var f=a,g=[];return b&&(f+=this._getCurrentState()),f+=String.contains(f,"?")?"&":"?",c.push("compId"),Array.each(c,function(a){var b=this._getValue(f,d,e,a);(b||0===b)&&g.push(a+"="+encodeURIComponent(b))}.bind(this)),f+g.join("&")},_getCacheKiller:function(){return(new Date).getTime().toString()},_getCurrentState:function(){var a=this.resources.W.Utils.hash.getHashParts(location.hash);return a.extData?"/"+a.extData:""},_getValue:function(a,b,c,d){switch(d){case"app-state":return this._getCurrentState();case"instance":return c.instance;case"section-url":var e=b.getSectionURL();return!e||this.injects().Viewer.isPublicMode()?e:a;case"target":var e=b.getSectionURL();return this.injects().Viewer.isPublicMode()?e?"_top":null:"_self";case"width":return b.getViewNode().getWidth();case"locale":return this.resources.W.Config.getLanguage();case"viewMode":var f="site"===window.viewMode?W:parent.W,g=f.Viewer.getViewMode()||"unknown";return g;case"origCompId":return this.injects().Editor.getEditedComponent().getComponentId();case"compId":return b.getComponentId();case"cacheKiller":return this._getCacheKiller()}}})}),define.Class("wysiwyg.viewer.components.traits.TPAHandlersBase",function(a){var b=a;b.resources(["W.Config","W.Commands","W.Viewer","W.Utils","W.Data"]),b.methods({_appIsAlive:!1,initialize:function(){return this._changeSize?(this._isAliveTime=0,this._isAliveCounter=0,void 0):new Error("Must... Implement... _changeSize...")},handleAppIsAlive:function(){this._appIsAlive=!0,this._isAliveTime=new Date,this._isAliveCounter++},handleSiteInfo:function(a){var b=this._getSiteSEOParams();b.pageTitle=this._getCurrentPageName(),b.referer=document.referrer,b.url=location.href,b.baseUrl=this._getSiteBaseUrl(),a.callback(b)},_getSitePages:function(a){for(var b=[],c=0,d=a.length;d>c;c++){for(var e=this._getPageInfo(a[c]),f=a[c].get("items"),g=0,h=f.length;h>g;g++){var i=this._getPageInfo(f[g]);e.subPages=e.subPages||[],e.subPages.push(i)}b.push(e)}return b},_getPageInfo:function(a){var b={},c=a.get("refId"),d=this._datam.getDataByQuery(c);return b.title=d.get("title")||"",b.id=0===c.indexOf("#")?c.substr(1):c,b.hide=d.get("hidePage")||!1,b},_getSiteSEOParams:function(){var a=W.Viewer.getViewMode();switch(a){case"editor":return this._getSiteSEOParamsInEditMode();case"preview":return this._getSiteSEOParamsInPreviewMode();case"site":return this._getSiteSEOParamsInViewMode()}return{}},_getSiteBaseUrl:function(){var a=location.protocol+"//"+location.host+location.pathname;return"editor"==W.Viewer.getViewMode()?a=window.parent.W.Config.siteNeverSavedBefore()?"":this.resources.W.Config.getUserPublicUrl():"preview"==W.Viewer.getViewMode()&&(a=window.parent.W.Config.siteNeverSavedBefore()?"":window.parent.W.Config.getUserPublicUrl()||""),a},_getMetadataParameter:function(a,b){var c=$$("meta["+(b||"name")+"='"+a+"']"),d="";if(c&&c.length>0){var e=c.get("content");e.length>0&&(d=e[0])}return d},_getSiteSEOParamsInViewMode:function(){var a=$$("title");return a=a&&a[0]&&a[0].text,{siteTitle:a||"",siteDescription:this._getMetadataParameter("description")||"",siteKeywords:this._getMetadataParameter("keywords")||""}},_getSiteSEOParamsInPreviewMode:function(){var a=window.parent.W.Data.getDataByQuery("#SITE_SETTINGS"),b=a.getData()||{};return{siteTitle:b.siteTitleSEO||"",siteDescription:b.siteDescriptionSEO||"",siteKeywords:b.keywordsSEO||""}},_getSiteSEOParamsInEditMode:function(){var a=this.resources.W.Data.getDataByQuery("#SITE_SETTINGS"),b=a.getData()||{};return{siteTitle:b.siteTitleSEO||"",siteDescription:b.siteDescriptionSEO||"",siteKeywords:b.keywordsSEO||""}},_getCurrentPageName:function(){var a=null;try{var b=window.rendererModel?this.resources.W.Viewer:this.resources.W.Preview.getPreviewManagers().Viewer,c=b.getCurrentPageNode().getLogic().getDataItem();a=c.getData()}catch(d){return""}return a&&a.title||""}})});